var TB={mouse:{x:0,y:0},isMobile:false,tooltip:null,cache:{tooltip:[]},timer:{tooltip:null},loading:null,window:null,message:null,scrollTop:0};function _clickOut($t,id,func){$(document).off("click.tbx_"+id+" touchstart.tbx_"+id).on("click.tbx_"+id+" touchstart.tbx_"+id,function(e){if(e.type==="touchstart"){e=e.originalEvent.touches[0]}if(!$t.is(e.target)&&!$t.has(e.target).length){func();$(document).off("click.tbx_"+id+" touchstart.tbx_"+id)}})}function _checkForm($f){if($f.length){var s=true;$f.find(".field-is-required").each(function(){var $i=$(this).find("input");if(!$i.length){$i=$(this).find("select")}if(!$i.length){$i=$(this).find("textarea")}if($i.length&&!$i.val().length){s=false;$i.focus();var $ff=$i.parents(".form-field");$ff.addClass("focus");$i.on("blur",function(){$ff.removeClass("focus")});return false}});return s}return false}function _showMessage(message){if(message.length){TB.message.fadeIn(100).animate({top:64},200).find(".wrapper").html(message);_clickOut(TB.message.find(".wrapper"),"message",function(){TB.message.animate({top:-TB.message.outerHeight()},200)})}}function _parseJ($targets,j){j=$.extend({htmlValues:{},htmlModes:{},hideTarget:false,removeTarget:false,refresh:false,redirectTo:"",closeWindow:false,message:"",status:0},j);TB.loading.hide();_showMessage(j.message);if(j.refresh){location.reload(true)}else{if(j.redirectTo!==""){document.location=j.redirectTo}else{if(j.removeTarget){$targets.from.fadeOut(500,function(){$(this).remove()});$targets.parent.fadeOut(500,function(){$(this).remove()})}if(j.hideTarget){$targets.from.fadeOut(500);$targets.parent.fadeOut(500)}$.each($targets,function(k,$target){if($target.length&&typeof j.htmlValues[k]!=="undefined"&&j.htmlValues[k].length){switch(j.htmlModes[k]){case"_appendBefore":$target.html(j.htmlValues[k]+$target.html());break;case"_appendAfter":if($target.is("textarea")){$target.val($target.val()+j.htmlValues[k])}else{$target.append(j.htmlValues[k])}break;default:$target.html(j.htmlValues[k])}_tbx(false)}});if(j.closeWindow){_closeWindow()}}}}function _post($from,opt){opt=$.extend({action:_getAction($from),targets:_getTargets($from),vars:_getVars($from),onLoading:function(){},onLoaded:function(){},showLoading:true},opt);if(opt.showLoading){TB.loading.show()}opt.onLoading();$.post(opt.action,opt.vars,function(j,s,x){_parseJ(opt.targets,j);opt.onLoaded(j)},"json");return false}function _getVars($from){if($from.is("form")){return $from.serialize()}var $vars=$from.children("meta[name=vars]");if($vars.length){return $vars.attr("content").toString().replace(/;/g,"&")}return""}function _getAction($from){var $action="";if($from.is("a")){$action=$from.attr("href").toString();if($action!=="#"){return jroot+$action}}$action=$from.children("meta[name=action]");if($action.length){return jroot+$action.attr("content").toString()}$action=$from.children("input[name=action]");if($action.length){return jroot+$action.val()}if($from.is("form[action]")){$action=$from.attr("action").toString();if($action!==""){return jroot+$action}}return document.location}function _getTargets($from){var $targets={from:$from,parent:$from.parents(".tbx-target:first")},_app=function(t){var $t=$(".tbx-target-"+t);if($t.length){$targets[t]=$t}};$from.find("meta.tbx-targets").each(function(i){_app($(this).attr("content").toString())});$from.find("input.tbx-targets").each(function(i){_app($(this).val())});return $targets}function _getFormData(form){var $inputs=$('input[type="file"]:not([disabled])',form);$inputs.each(function(_,input){if(input.files.length>0){return}$(input).prop("disabled",true)});var formData=new FormData(form);$inputs.prop("disabled",false);return formData}function _closeWindow(){if(TB.isMobile){var $body=$(document.body);$body.css({overflow:"auto",position:"static",top:0}).width("auto");$("body,html").scrollTop(TB.scrollTop)}$("#window").hide();return false}function _openWindow($from,moreVars){var $theWindow=$("#window"),$wrapper=$theWindow.find(".wrapper"),moveOffset=null;_resetTooltip();return _post($from,{targets:$.extend(_getTargets($from),{WINDOW:$wrapper}),vars:_getVars($from)+"&"+moreVars,onLoaded:function(j){$theWindow.show();if(TB.isMobile){TB.scrollTop=TB.window.scrollTop();var $body=$(document.body),snWidth=$body.innerWidth();$body.css({overflow:"hidden",position:"fixed",top:-TB.scrollTop}).width(snWidth);$theWindow.addClass("maximized");$wrapper.find(".minimize,.maximize").hide()}else{$wrapper.find(".minimize,.maximize").on("click",function(e){e.preventDefault();$theWindow.toggleClass("maximized");return false});$(document).off("keyup.modal").on("keyup.modal",function(e){if((window.event?window.event.keyCode:e.which)===27){var $suggestions=$wrapper.find(".tbx-suggestions-target").find("li");if($suggestions.length===0){_closeWindow()}else{$suggestions.remove()}}})}$wrapper.find(".close").on("click",function(e){e.preventDefault();return _closeWindow()});var $af=$wrapper.find(".autofocus,[autofocus]").focus();if($af.length>0){var af=$af.get(0),afLength=$af.val().length;if(af.createTextRange){var range=af.createTextRange();range.move("character",afLength);range.select()}else if(af.selectionStart!==null){af.focus();af.setSelectionRange(afLength,afLength)}}$wrapper.find(".tbx-child-window-form").off("submit").on("submit",function(){var $this=$(this);if(_checkForm($this)){_post($this,{targets:_getTargets($from)})}return false})}})}function _resetTooltip(){$(".tooltip").hide();TB.tooltip=null;clearTimeout(TB.timer.tooltip);TB.timer.tooltip=null}function _tbx(needResizing){if(!needResizing){$(".tbx-click").off("click").on("click",function(){return _post($(this),{})});$(".tbx-form").off("submit").on("submit",function(){var $this=$(this);if(_checkForm($this)){_post($this,{})}return false}).find("a.tbx-auto-submit").off("click").on("click",function(){var $this=$(this).parents(".tbx-form:first");if(_checkForm($this)){_post($this,{})}return false});$(".tbx-get-form").off("submit").on("submit",function(){if(_checkForm($(this))){this.submit()}return false}).find(".tbx-auto-submit").off("change").on("change",function(){this.form.submit()});$("a.tbx-window,button.tbx-window").off("click").on("click",function(){return _openWindow($(this),"")});$("form.tbx-window").off("submit").on("submit",function(){return _openWindow($(this),"")}).find("select.tbx-auto-submit").off("change").on("change",function(){_openWindow($(this).parents("form.tbx-window"),"")}).end().find("a.tbx-auto-submit").off("click").on("click",function(){var $this=$(this);return _openWindow($this.parents("form.tbx-window"),_getVars($this))});$(".tbx-remove").off("click").on("click",function(){$(this).parents(".tbx-target").remove();return false});if(!TB.isMobile){$(".tbx-tooltip").each(function(){var $this=$(this),_move=function(e){if(!TB.tooltip){return false}TB.tooltip.show().css({top:e.pageY>TB.window.height()/2+TB.window.scrollTop()?e.pageY-TB.tooltip.innerHeight()-10:e.pageY+20,left:e.pageX>TB.window.width()/2?e.pageX-TB.tooltip.innerWidth()-10:e.pageX+20})};$this.off(".tooltip").on("mouseenter.tooltip",function(e){_resetTooltip();var vars=_getVars($this).split(":"),index=vars[0]+":"+vars[1];if(!(index in TB.cache.tooltip)){TB.timer.tooltip=setTimeout(function(){$.post(jroot+"/actions.php","commit=loadTooltip&objectId="+vars[1]+"&objectType="+vars[0],function(j){if(TB.timer.tooltip){TB.cache.tooltip[index]=$("<div></div>").addClass("tooltip").appendTo("#content").html(j.htmlValues.TOOLTIP);TB.tooltip=TB.cache.tooltip[index];_move(e)}},"json")},600)}else{TB.tooltip=TB.cache.tooltip[index];_move(e)}}).on("mousemove.tooltip",function(e){_move(e)}).on("mouseleave.tooltip",function(){_resetTooltip()})})}$(".tbx-password").each(function(){var $this=$(this),$pass=$this.find("input[type=password]"),$show=$this.find(".show"),$hide=$this.find(".hide").hide(),$gen=$this.find(".random");$gen.off("click").on("click",function(e){e.preventDefault();var s="",exclude=[34,39,44,47,92,94,96,124],excluded=exclude.length,n=54,i=0;while(s.length<16){n=Math.floor(Math.random()*92)+33;for(i=0;i<excluded;i+=1){if(n===exclude[i]){n=54}}s+=String.fromCharCode(n)}$pass.val(s);return false});$show.off("click").on("click",function(e){e.preventDefault();$show.hide();$hide.show();$pass.attr("type","text");return false});$hide.off("click").on("click",function(e){e.preventDefault();$hide.hide();$show.show();$pass.attr("type","password");return false})});$(".tbx-score").each(function(){var $this=$(this),$stars=$this.find("a.star"),$reset=$this.find("a.reset"),$value=$this.find("input[type=hidden]"),current=$value.val(),_on=function(offset,store){$stars.removeClass("on");$this.find("a:lt("+offset+")").addClass("on");if(store){$value.val(offset);current=offset}};$reset.on("click",function(){_on(-99,true);return false});$stars.on("click",function(){_on($(this).index()+1,true);return false}).hover(function(){_on($(this).index()+1,false)},function(){_on(current,false)});$this.on("mouseleave",function(){_on(Math.max(0,current),true)})});$(".tbx-textarea").each(function(){var $this=$(this),max=$this.attr("limit").toString(),_u=function(){var l=$this.val().length;$this.siblings(".textarea-meta").find(".limit").html(l).toggleClass("limit-overflow",l>max)};$this.off("keyup").on("keyup",_u);_u()});$(".tbx-bbcode").each(function(){var $this=$(this),$target=$this.find("textarea");$this.find(".tbx-bbcode-button").off("click").on("click",function(){var $button=$(this),t=$target.get(0),s=$button.find("meta[name=left]").attr("content").toString(),e=$button.find("meta[name=right]").attr("content").toString();if("selectionStart"in t){var ss=t.selectionStart,se=t.selectionEnd;t.value=t.value.substr(0,ss)+s+(se-ss>0?t.value.substr(ss,se-ss):"")+e+t.value.substr(se,t.value.length);if(e.match(/^\[\/img]/)){s+=e}t.selectionStart=ss+s.length;t.selectionEnd=ss+s.length;t.focus()}else if(document.selection){document.selection.createRange().text=s+document.selection.createRange().text+e;t.focus()}else{t.value+=s+e}return false});$this.find("a.tbx-bbcode-pictures").off("click").on("click",function(){var $button=$(this),$pictures=$this.find("div.tbx-bbcode-pictures");if($button.hasClass("on")&&!$button.hasClass("toggle")){$button.removeClass("on");$pictures.html("")}else{_post($button,{action:jroot+"/actions.php",targets:{BBPICTURES:$pictures},vars:"commit=bbcode&do=loadPictures&"+_getVars($button),onLoaded:function(){$button.addClass("on")}})}return false});if($target.is("[limit]")){var limit=parseInt($target.attr("limit").toString()),$count=$this.find(".count"),_u=function(){var l=$target.val().length;$count.html(l+"/"+limit).toggleClass("overflow",l>limit)};$target.off("keyup").on("keyup",_u);_u()}$this.find("a.tbx-bbcode-preview").off("click").on("click",function(){var $button=$(this),$preview=$this.find("div.tbx-bbcode-preview");if($button.hasClass("on")){$target.show();$preview.html("");$button.removeClass("on")}else{_post($button,{action:jroot+"/actions.php",targets:{BBPREVIEW:$preview},vars:"commit=bbcode&do=loadPreview&content="+encodeURIComponent($target.val()),onLoaded:function(){$target.hide();$button.addClass("on")}})}return false})});$(".tbx-toggle").each(function(){var $this=$(this),$shown=$this.find(".tbx-toggle-shown-label").hide(),$hidden=$this.find(".tbx-toggle-hidden-label"),$target=$this.siblings(".tbx-toggle-target");if(!$target.length){$target=$($this.find("meta[name=vars]").attr("content").toString())}if($this.is("input")){$target.toggle($this.is(":checked"));$this.off("click").on("click",function(){$target.toggle()})}else{if(!$this.hasClass("clicked")){$target.hide()}$this.off("click").on("click",function(){$this.addClass("clicked");$target.toggle();$hidden.toggle();$shown.toggle();if($this.hasClass("tbx-toggle-hide-then")){$this.hide()}return false})}});$(".tbx-suggestions").each(function(){var $this=$(this),$form=$this.parents("form:first"),$input=$this.find("input[type=text]"),$target=$this.find(".tbx-suggestions-target"),$picks=$this.find(".tbx-picked-suggestions"),prevValue="",timer=null,$inSection=$this.parents("section");if($inSection.length){var mH=$inSection.height()-40-($this.offset().top-$inSection.offset().top);$this.find(".suggestions").css("max-height",mH+"px")}if(!$picks.find("li").length){$picks.hide()}$input.off("keyup").on("keyup",function(e){var k=window.event?window.event.keyCode:e.which;switch(k){case 27:clearTimeout(timer);timer=null;$target.hide();break}}).off("focusin").on("focusin",function(){var _suggest=function(){var value=$input.val();if(value.length){if(value!==prevValue){_post($this,{action:jroot+"/actions.php",targets:{SUGGESTIONS:$target},vars:_getVars($this)+"&value="+encodeURIComponent(value),onLoading:function(){TB.loading.hide()},onLoaded:function(){prevValue=value;$target.show().find("a.auto").off("click").on("click",function(){var $a=$(this),selValue=$a.find("meta[name=value]").attr("content").toString();prevValue=selValue;if($form.hasClass("tbx-window")){$input.val(selValue);return _openWindow($form,"")}else if($form.hasClass("tbx-searchbox")){if($input.hasClass("tbx-multiple")){$input.val("");$target.hide();return _post($(this),{action:_getAction($this),targets:{PICKS:$picks},vars:_getVars($this)+"&pick=1&objectId="+encodeURIComponent(selValue),onLoaded:function(){$picks.show()}})}else{$input.val(selValue);$target.hide();clearTimeout(timer)}}else if($form.hasClass("tbx-form")){$input.val(selValue);if(!$a.hasClass("no-submit")){_post($form,{})}else{$target.hide();clearTimeout(timer)}return false}else if($form.hasClass("tbx-get-form")){$input.val(selValue);$form.submit();return false}else{$input.val(selValue);$target.hide();clearTimeout(timer)}return false})}})}}else{$target.hide()}timer=setTimeout(_suggest,1e3)};_clickOut($this,"SUGGESTIONS",function(){clearTimeout(timer);timer=null;$target.hide()});_suggest()}).off("focusout").on("focusout",function(){clearTimeout(timer);timer=null})});$(".tbx-date").each(function(){var htmlObjects={target:$(this),main:$('<div class="date-chooser"></div>'),date:$('<nav class="date"></nav>'),year:$('<span class="year"></span>'),month:$('<span class="month"></span>'),days:$('<div class="days"></div>')};$(this).siblings(".date-chooser").remove();var curDate=htmlObjects.target.val(),d=new Date,today={year:d.getUTCFullYear(),month:d.getUTCMonth()+1,day:d.getUTCDate()},curValues={year:today.year,month:today.month,day:0},localeMonths=htmlObjects.target.attr("_months").toString().split("|"),localeDays=htmlObjects.target.attr("_days").toString().split(",");if(curDate.length&&curDate!=="0000-00-00"){d=new Date(curDate);curValues={year:d.getUTCFullYear(),month:d.getUTCMonth()+1,day:d.getUTCDate()}}var navValues=$.extend({},curValues);var handles={nextYear:$('<a href="#">&rsaquo;</a>'),prevYear:$('<a href="#">&lsaquo;</a>'),nextMonth:$('<a href="#">&rsaquo;</a>'),prevMonth:$('<a href="#">&lsaquo;</a>')};handles.nextYear.off("click").on("click",function(){navValues.year++;return _flush()});handles.prevYear.off("click").on("click",function(){navValues.year--;return _flush()});handles.nextMonth.off("click").on("click",function(){navValues.month++;if(navValues.month===13){navValues.month=1;navValues.year++}return _flush()});handles.prevMonth.off("click").on("click",function(){navValues.month--;if(navValues.month===0){navValues.month=12;navValues.year--}return _flush()});htmlObjects.month.append(handles.prevMonth,$('<span class="value"></span>'),handles.nextMonth);htmlObjects.year.append(handles.prevYear,$('<span class="value"></span>'),handles.nextYear);htmlObjects.date.append(htmlObjects.month,htmlObjects.year).appendTo(htmlObjects.main);htmlObjects.days.appendTo(htmlObjects.main);var _flush=function(){htmlObjects.month.find(".value").html(localeMonths[navValues.month-1]);htmlObjects.year.find(".value").html(navValues.year);d=new Date(Date.UTC(navValues.year,navValues.month,0));var countDays=d.getUTCDate();d=new Date(Date.UTC(navValues.year,navValues.month-1,1));var firstDay=d.getUTCDay()-1;if(firstDay<0){firstDay=6}htmlObjects.days.html("");var i=0,day=0,$day=null,_onDayClick=function(){var $this=$(this);if($this.hasClass("selected")){htmlObjects.main.find(".day a").removeClass("selected");htmlObjects.target.val("0000-00-00")}else{htmlObjects.main.find(".day a").removeClass("selected");$this.addClass("selected");curValues.month=navValues.month;curValues.year=navValues.year;curValues.day=parseInt($this.find(".value").html());htmlObjects.target.val(curValues.year+"-"+(curValues.month<10?"0":"")+curValues.month+"-"+(curValues.day<10?"0":"")+curValues.day)}return false};if(localeDays.length===7){for(i=0;i<7;i+=1){htmlObjects.days.append($('<div class="day dow"></div>').html(localeDays[i]))}}for(i=0;i<countDays+firstDay;i+=1){day=i+1-firstDay;$day=$("<span>&nbsp;</span>");if(day>0){$day=$('<a href="#"></a>').html('<span class="value">'+day+'</span><span class="reset">&times;</span>').off("click").on("click",_onDayClick)}if(navValues.year===today.year&&navValues.month===today.month&&day===today.day){$day.addClass("today")}if(navValues.year===curValues.year&&navValues.month===curValues.month&&day===curValues.day){$day.addClass("selected")}htmlObjects.days.append($('<div class="day"></div>').html($day))}return false};htmlObjects.target.after(htmlObjects.main);_flush()});$(".tbx-color").each(function(){var _pos=function(event){if(event.type==="touchstart"||event.type==="touchend"||event.type==="touchmove"){event=event.originalEvent.touches[0]}return{x:event.pageX,y:event.pageY}},actions={move:"mousemove touchmove",start:"mousedown touchstart",end:"mouseup touchend"};var _getRGBMatrix=function(er,eg,eb){var r=0,g=0,b=0,n=149;var dr=er/n,dg=eg/n,db=eb/n;var d=Math.max(dr,dg,db);var mx=new Array(n+1);var i=0;var j=0;for(i=0;i<=n;i+=1){mx[i]=new Array(n+1);for(j=0;j<=n;j+=1){mx[i][j]={r:Math.round(r),g:Math.round(g),b:Math.round(b)};r+=dr;g+=dg;b+=db}dr+=(d-er/n)/n;dg+=(d-eg/n)/n;db+=(d-eb/n)/n;r=0;g=0;b=0}return mx};var _getHUEMatrix=function(){var n=149,r=255,g=0,b=0;var d=255/n*6;var mx=new Array(n+1);var i=0;for(i=0;i<=n;i+=1){mx[i]={r:Math.round(r),g:Math.round(g),b:Math.round(b)};if(r===255&&g===0&&b<255){b+=d}if(r>0&&g===0&&b===255){r-=d}if(r===0&&g<255&&b===255){g+=d}if(r===0&&g===255&&b>0){b-=d}if(r<255&&g===255&&b===0){r+=d}if(r===255&&g>0&&b===0){g-=d}if(r>255){r=255}if(g>255){g=255}if(b>255){b=255}if(r<0){r=0}if(g<0){g=0}if(b<0){b=0}}return mx};var _d2h=function(d){var r=d.toString(16);if(r.length<2){r="0"+r}return r};var $this=$(this).attr("autocomplete","off").css({padding:"8px"}),I=$this.offset(),$m=$('<div style="height:170px"></div>').addClass("tbx-color-palet"),$p=$('<div style="position:relative;float:left;margin:8px 2px 0 2px;width:150px;height:150px;background:#f00 url('+jroot+'/ressources/overlay.png)"></div>'),$phy=$('<div style="position:absolute;width:1px;height:150px;background:#fff;top:0;left:0"></div>'),$phx=$('<div style="position:absolute;width:150px;height:1px;background:#fff;top:0;left:0"></div>'),$h=$('<div style="position:relative;float:left;margin:8px 2px 0 2px;width:17px;height:150px;background:#fff url('+jroot+'/ressources/hue.png)"></div>'),$hh=$('<div style="position:absolute;width:17px;height:1px;background:#fff;"></div>'),mvp=false,mvh=false;$this.siblings(".tbx-color-palet").remove();$p.append($phy,$phx);$h.append($hh);$m.css({top:I.top,left:I.left+$this.outerWidth()+5});$m.append($p,$h).insertAfter($this);var rgbX=0,rgbY=0;var rgbs=_getRGBMatrix(255,0,0);var hues=_getHUEMatrix();var _update_val=function(){$this.val(_d2h(rgbs[rgbY][rgbX].r)+_d2h(rgbs[rgbY][rgbX].g)+_d2h(rgbs[rgbY][rgbX].b));$this.css({backgroundColor:"rgb("+rgbs[rgbY][rgbX].r+","+rgbs[rgbY][rgbX].g+","+rgbs[rgbY][rgbX].b+")",color:Math.max(rgbs[rgbY][rgbX].r,rgbs[rgbY][rgbX].g,rgbs[rgbY][rgbX].b)>200?"#000":"#fff"})};var _update_hue=function(e){var mp=_pos(e),h=Math.round(Math.max(0,Math.min(149,mp.y-$h.offset().top)));rgbs=_getRGBMatrix(hues[h].r,hues[h].g,hues[h].b);$hh.css("top",h);$p.css("backgroundColor","rgb("+hues[h].r+","+hues[h].g+","+hues[h].b+")");_update_val()};var _update_rgb=function(e){var mp=_pos(e),P=$p.offset();rgbX=Math.round(Math.max(0,Math.min(149,mp.x-P.left)));rgbY=Math.round(Math.max(0,Math.min(149,mp.y-P.top)));$phy.css("left",rgbX);$phx.css("top",rgbY);_update_val()};$h.off(actions.start).on(actions.start,function(e){mvh=true;_update_hue(e);return false});$p.off(actions.start).on(actions.start,function(e){mvp=true;_update_rgb(e);return false});$m.off(actions.end).on(actions.end,function(){mvp=false;mvh=false}).off(actions.move).on(actions.move,function(e){if(mvh){_update_hue(e)}if(mvp){_update_rgb(e)}})});if($(".bbcode").length){var $pictures=$("img[tbx-src]"),_load=function(){$pictures.each(function(){var $this=$(this);if($this.offset().top+100<TB.window.height()+TB.window.scrollTop()){$this.attr("src",$this.attr("tbx-src"));$pictures=$pictures.not($this)}})};if($pictures.length){TB.window.off("scroll.bbcodeLoadPictures resize.bbcodeLoadPictures").on("scroll.bbcodeLoadPictures resize.bbcodeLoadPictures",_load);_load()}}$(".tbx-upload-form").each(function(){var $this=$(this);$this.off("submit").on("submit",function(){if(_checkForm($this)){TB.loading.show();var data=_getFormData($this.get(0)),$progress=$("#progress").show();var xhr=new XMLHttpRequest;xhr.upload.addEventListener("progress",function(e){$progress.css({width:parseInt(e.loaded/e.total*100,10)+"%"})},false);xhr.open("POST",document.location,true);xhr.onreadystatechange=function(){if(xhr.readyState===4){if(xhr.status===200){var j=JSON.parse(xhr.responseText);_parseJ(_getTargets($this),j);$progress.hide();if(j.fileURIs.length){var index=0;$this.find(".tbx-uploaded-images").each(function(){$(this).attr("src",j.fileURIs[index]);index++})}$this.find("input[type=file]").val("").siblings(".tbx-files").html("")}}};xhr.send(data)}return false});$this.find("input[type=file]").off("change").on("change",function(e){var files=e.target.files,count=files.length,$input=$(this),$target=$input.siblings(".tbx-files").html(""),allow=["image/jpeg","image/gif","image/png"];if($target.length&&files.length){var i=0,file=null;for(i=0;i<count;i+=1){file=files[i];$target.show().append("<li><span class='file-name'>"+encodeURIComponent(file.name)+"</span><span class='file-type'>"+file.type+"</span><span class='file-size'>"+Math.round(file.size/1024)+"KB</span></li>")}}})});$("form.tbx-crop").each(function(){var $this=$(this),f=$this.get(0),trueWidth=parseInt($this.find("meta[name=w]").attr("content")),trueHeight=parseInt($this.find("meta[name=h]").attr("content")),ratio=trueWidth/trueHeight,zoomRatio=1,showWidth=trueWidth,showHeight=Math.round(trueWidth/ratio),a=parseInt($this.find("meta[name=a]").attr("content")),u=$this.find("meta[name=from]").attr("content").toString(),xsnap=0,ysnap=0,vpo=0,pos={top:0,left:0,bottom:0,right:0},$viewport,$wrist={},$selection,$moving=null,$resizing=null,actions={move:"mousemove touchmove",start:"mousedown touchstart",end:"mouseup touchend"};$viewport=$('<div style="margin:8px auto;position:relative;width:'+showWidth+'px;max-width:96%;box-shadow:0 0 8px rgba(0,0,0,.4)"></div>').html('<img style="display:block;max-width:100%" src="'+u+'" alt="" /><div style="position:absolute;background:transparent url(\''+jroot+"/ressources/alpha.png') top left;top:0;left:0;right:0;bottom:0\"></div>").appendTo($this);$selection=$('<div style="position:absolute;border:1px dashed firebrick;margin:0;padding:0;cursor:move;"></div>').appendTo($viewport);$('<div style="margin:12px;text-align:center"><input type="hidden" name="commit" value="crop" /><input type="hidden" name="x" value="'+Math.max(0,Math.round(trueWidth/2-a/2))+'" /><input type="hidden" name="y" value="'+Math.max(0,Math.round(trueHeight/4-a/2))+'" /><input type="hidden" name="a" value="'+a+'" /><input type="submit" /></div>').appendTo($this);var $w=$('<span style="display:block;position:absolute;width:6px;height:6px;border:1px outset #666;background-color:#eee"></span>');$wrist.se=$w.clone().css({cursor:"se-resize"}).appendTo($viewport);$wrist.sw=$w.clone().css({cursor:"sw-resize"}).appendTo($viewport);$wrist.nw=$w.clone().css({cursor:"nw-resize"}).appendTo($viewport);$wrist.ne=$w.clone().css({cursor:"ne-resize"}).appendTo($viewport);var _init=function(write){showWidth=$viewport.width();showHeight=Math.round(showWidth/ratio);zoomRatio=trueWidth/showWidth;a=Math.min(Math.round(parseInt(f.a.value)/zoomRatio),showWidth-2,showHeight-2);pos.top=Math.round(parseInt(f.y.value)/zoomRatio);pos.left=Math.round(parseInt(f.x.value)/zoomRatio);pos.bottom=showHeight-a-pos.top;pos.right=showWidth-a-pos.left;vpo=$viewport.offset();_update(write)};var _update=function(write){$selection.css({top:pos.top,left:pos.left,bottom:pos.bottom,right:pos.right,background:"#fff url("+u+") no-repeat "+parseInt(-pos.left,10)+"px "+parseInt(-pos.top,10)+"px"+" / "+showWidth+"px"});a=showWidth-pos.left-pos.right;$wrist.se.css({top:pos.top+a-5,left:pos.left+a-5});$wrist.sw.css({top:pos.top+a-5,left:pos.left-3});$wrist.nw.css({top:pos.top-3,left:pos.left-3});$wrist.ne.css({top:pos.top-3,left:pos.left+a-5});if(write){f.x.value=Math.round(parseInt(pos.left,10)*zoomRatio);f.y.value=Math.round(parseInt(pos.top,10)*zoomRatio);f.a.value=Math.round(parseInt(a,10)*zoomRatio)}};var _pos=function(event){if(event.type==="touchstart"||event.type==="touchend"||event.type==="touchmove"){event=event.originalEvent.touches[0]}return{x:event.pageX,y:event.pageY}};var _initMove=function(e){$moving=$selection;var p=_pos(e);xsnap=p.x-vpo.left-pos.left;ysnap=p.y-vpo.top-pos.top;return false};var _rock=function(e){var p=_pos(e);if($moving){a=showWidth-pos.left-pos.right;pos.left=Math.min(showWidth-a,Math.max(0,p.x-vpo.left-xsnap));pos.top=Math.min(showHeight-a,Math.max(0,p.y-vpo.top-ysnap));pos.right=showWidth-pos.left-a;pos.bottom=showHeight-pos.top-a;_update(true)}if($resizing){var tx=p.x-vpo.left,ty=p.y-vpo.top;switch($resizing){case $wrist.se:pos.right=Math.min(showWidth-pos.left-30,Math.max(0,showWidth-tx));pos.bottom=showHeight-showWidth-pos.top+pos.right+pos.left;if(pos.bottom<0){pos.bottom=0;pos.right=pos.bottom-showHeight+showWidth+pos.top-pos.left}break;case $wrist.ne:pos.right=Math.min(showWidth-pos.left-30,Math.max(0,showWidth-tx));pos.top=showHeight-showWidth-pos.bottom+pos.right+pos.left;if(pos.top<0){pos.top=0;pos.right=pos.top-showHeight+showWidth+pos.bottom-pos.left}break;case $wrist.nw:pos.left=Math.min(showWidth-pos.right-30,Math.max(0,tx));pos.top=showHeight-showWidth-pos.bottom+pos.right+pos.left;if(pos.top<0){pos.top=0;pos.left=pos.top-showHeight+showWidth+pos.bottom-pos.right}break;case $wrist.sw:pos.left=Math.min(showWidth-pos.right-30,Math.max(0,tx));pos.bottom=showHeight-showWidth-pos.top+pos.right+pos.left;if(pos.bottom<0){pos.bottom=0;pos.left=pos.top-showHeight+showWidth+pos.bottom-pos.right}break}_update(true)}return false};var _initResize=function($wrist){$resizing=$wrist;return false};$this.on(actions.move,function(e){_rock(e)});$selection.on(actions.start,function(e){e.preventDefault();return _initMove(e)});$wrist.se.on(actions.start,function(e){e.preventDefault();return _initResize($wrist.se)});$wrist.ne.on(actions.start,function(e){e.preventDefault();return _initResize($wrist.ne)});$wrist.sw.on(actions.start,function(e){e.preventDefault();return _initResize($wrist.sw)});$wrist.nw.on(actions.start,function(e){e.preventDefault();return _initResize($wrist.nw)});$(document).on(actions.end,function(){$moving=null;$resizing=null});$(window).on("resize.tbx-crop",function(){_init(false)});_init(true)});$(".tbx-normalize").each(function(){var $this=$(this);$this.off("click").on("click",function(){var $target=$this.parents(".associate").siblings("input[type=text]");_post($this,{action:jroot+"/actions.php",vars:"commit=normalize&string="+encodeURIComponent($target.val()),onLoaded:function(j){$target.val(j.htmlValues.STRING)}});return false})});$(".tbx-switch").each(function(){var $this=$(this);$this.off("click").on("click",function(){$this.toggleClass("on");$("[switch]").each(function(){var $switch=$(this),value=$switch.attr("switch").toString();if(value.length){$switch.attr("switch",$switch.html()).html(value)}});return false})});$(".tbx-pswp").each(function(){var $this=$(this),$pswp=$(".pswp");if($pswp.length){var pictures=JSON.parse(decodeURIComponent($this.find("meta").attr("content").toString()));$this.find("a").off("click").on("click",function(){var $a=$(this);var gallery=new PhotoSwipe($pswp.get(0),PhotoSwipeUI_Default,pictures,{index:parseInt($a.attr("_index")),history:false,getThumbBoundsFn:function(index){return{y:$a.offset().top,x:$a.offset().left,w:$a.width()}}});gallery.init();return false})}});$(".tbx-sort").each(function(){var $this=$(this),$sortables=$this.find(".sortable"),countSortables=$sortables.length;if(countSortables>0){$sortables.each(function(){$(this).find(".offset").val($sortables.index($(this))+1)});var _offset=function($from,direction){var $toSort=$from.parents(".sortable"),offset=$sortables.index($toSort);if(direction===-1&&offset>0||direction===1&&offset<countSortables-1){var $sorted=$toSort.clone();if(direction===-1){$sorted.insertBefore($sortables.eq(offset-1))}else{$sorted.insertAfter($sortables.eq(offset+1))}$toSort.remove();_tbx(false)}return false};$sortables.find(".up").off("click").on("click",function(){return _offset($(this),-1)});$sortables.find(".down").off("click").on("click",function(){return _offset($(this),1)})}});$(".tbx-check-value").each(function(){var $this=$(this),$input=$this.find("input"),$target=$this.find(".tbx-check-value-target");$input.off("focusout").on("focusout",function(){_post($this,{vars:_getVars($this)+"&"+$(".tbx-check-value input").serialize(),targets:{CHECK:$target}})})})}$(".tbx-menu").each(function(){var $this=$(this),$all=$(".tbx-menu"),$inSection=$this.parents("section");if($inSection.length){var mH=$inSection.height()-40-($this.offset().top-$inSection.offset().top);$this.find(".menu").css("max-height",mH+"px")}if(TB.isMobile){$this.find(".handle").off("click").on("click",function(){if($(this).hasClass("selected")){document.location=$(this).attr("href");return false}$all.find(".handle").removeClass("selected");$all.find(".menu").hide();TB.message.hide();$(this).addClass("selected");$this.find(".menu").show().find(".toggle").off("click").on("click",function(){var $toggle=$(this),$secondary=$toggle.siblings("ul.secondary");if($toggle.hasClass("selected")||!$secondary.length){document.location=$toggle.attr("href");return false}$this.find(".selected").removeClass("selected");$this.find("ul.secondary").hide();$toggle.addClass("selected");$secondary.show();return false});_clickOut($all,"_menu_"+$this.index(),function(){$all.find(".handle").removeClass("selected");$all.find(".menu").hide()});return false})}else{$this.off("mouseenter").off("mouseleave").on("mouseenter",function(){$all.find(".menu").hide();TB.message.hide();$this.find(".handle").addClass("selected");$this.find(".menu").fadeIn("fast")}).on("mouseleave",function(){$this.find(".handle").removeClass("selected");$this.find(".menu").hide()});if("ontouchstart"in window){$this.find(".handle").off("touchstart").on("touchstart",function(){if($(this).hasClass("selected")){document.location=$(this).attr("href");return false}$all.find(".menu").hide();TB.message.hide();$this.find(".handle").addClass("selected");$this.find(".menu").fadeIn("fast");_clickOut($all,"_menu_"+$this.index(),function(){$all.find(".handle").removeClass("selected");$all.find(".menu").hide()});return false})}}});$(".tbx-zoom").each(function(){var $this=$(this),$p=$this.find("img"),w=$p.outerWidth(),h=$p.outerHeight(),o=$p.offset(),$v=$this.siblings(".tbx-zoom-target"),d=parseFloat($v.attr("zoom")),$z=$this.find(".tbx-zoom-handle").hide(),a=$z.outerWidth();if(d>1){$this.mouseenter(function(){$z.show();$v.show()}).mouseleave(function(){$z.hide();$v.hide()});$z.add($p).off("mousemove.zoom").on("mousemove.zoom",function(e){var p={x:Math.min(w-a,Math.max(0,e.pageX-o.left-a/2)),y:Math.min(h-a,Math.max(0,e.pageY-o.top-a/2))};$v.css("backgroundPosition",Math.round(-p.x*d)+"px "+Math.round(-p.y*d)+"px");$z.css({top:Math.round(p.y),left:Math.round(p.x)})})}})}$(document).ready(function(){var $doc=$(this);TB.window=$(window);TB.loading=$("#loading").on("click",function(e){e.preventDefault();$(this).hide();return false});TB.message=$("#message");TB.isMobile=$(".mobile:visible").length>0;$(".tbx-auto").each(function(){var $this=$(this),$refresh=$this.find("meta[name=refresh]"),refresh=0;if($refresh.length){refresh=parseInt($refresh.attr("content").toString());if(refresh>1e3){var _r=function(){_post($this,{onLoaded:function(){setTimeout(_r,refresh)},showLoading:false})};_r()}}else{_post($this,{})}});_tbx(false);TB.window.on("resize",function(){TB.isMobile=$(".mobile:visible").length>0;_tbx(true)});$("footer").find(".top").on("click",function(e){e.preventDefault();$("html,body").animate({scrollTop:0},100);return false});if(!TB.isMobile){var Side=$("#side").find(".wrapper"),Wide=$("#wide").find(".wrapper"),SideHeight=0,WideHeight=0,SideWidth=0,HeaderHeight=0;if(Side.length&&Wide.length){TB.window.on("scroll resize load",function(){Side.attr("style","");SideWidth=Side.width();SideHeight=Side.outerHeight();WideHeight=Wide.outerHeight();HeaderHeight=$("header").outerHeight();if(WideHeight>=SideHeight){var SideOffset=Side.offset(),WindowHeight=TB.window.height();if(WindowHeight>SideHeight+SideOffset.top){if(TB.window.scrollTop()>SideOffset.top-HeaderHeight){if(TB.window.scrollTop()>WideHeight-SideHeight){Side.css({position:"fixed",top:HeaderHeight-TB.window.scrollTop()+(WideHeight-SideHeight),left:SideOffset.left-TB.window.scrollLeft(),width:SideWidth})}else{Side.css({position:"fixed",top:HeaderHeight,left:SideOffset.left-TB.window.scrollLeft(),width:SideWidth})}}}else{var FooterHeight=$("footer").outerHeight();if(WindowHeight+TB.window.scrollTop()>SideHeight+SideOffset.top+FooterHeight){Side.css({position:"fixed",bottom:FooterHeight,left:SideOffset.left-TB.window.scrollLeft(),width:SideWidth})}}}})}}var commentOffset=$("#refCommentId-"+document.location.toString().split("#refCommentId-")[1]).addClass("spotlighted").offset();if(commentOffset){$("html,body").animate({scrollTop:commentOffset.top-64},100)}$("h1 .ellipsis").each(function(){var $this=$(this),maxHeight=parseInt($this.css("line-height"))*4;if($this.outerHeight()>maxHeight){$this.addClass("closed");var $roll=$("<span></span>").addClass("roll").html("&hellip;").appendTo($this).on("click",function(){$this.removeClass("closed");$this.addClass("opened");$roll.hide();return false})}});$(".tbx-checkable").each(function(){var $this=$(this),$head=$this.find(".tbx-checkable-head"),$handles=$this.find(".tbx-checkable-handle a"),$mains=$this.find(".tbx-checkable-main-handle a"),$buttons=$this.find(".tbx-checkable-button"),$counts=$this.find(".tbx-checkable-count"),curIndex=0,total=$handles.length,_count=function(){var count=$this.find("li.checked").length;$counts.html(count>0?count:"");$buttons.toggle(count>0);$mains.toggleClass("checked",count===total)},_check=function($handle,checked){var value=$handle.siblings("meta[name=value]").attr("content").toString();$handle.toggleClass("checked",checked);$handle.parents("li:first").toggleClass("checked",checked);$handle.siblings("input[type=hidden]").val($handle.hasClass("checked")?value:"0");_count();return false};$handles.on("click",function(e){e.preventDefault();var $handle=$(this);if(e.shiftKey){var index=$handles.index($handle);if(curIndex>index){var v=curIndex;curIndex=index;index=v}$handles.slice(curIndex,index).add($handle).each(function(){_check($(this),true)});return false}curIndex=$handles.index($handle);return _check($handle,!$handle.hasClass("checked"))});$mains.on("click",function(e){e.preventDefault();var $main=$(this).toggleClass("checked"),checked=$main.hasClass("checked");$handles.each(function(){_check($(this),checked)});return false});$buttons.filter("[window]").on("click",function(){$this.find("input[name=window]").val($(this).attr("window").toString())});$this.find(".listing-item").hover(function(){$(this).addClass("hovered")},function(){$(this).removeClass("hovered")});if($head.length){var $header=$("header"),HeaderHeight=$header.outerHeight(),snapTop=$head.offset().top;TB.window.on("scroll resize load",function(){var width=$head.width(),delta=HeaderHeight+$header.position().top;if(snapTop<TB.window.scrollTop()+delta){$this.addClass("pinned");$head.css({top:delta,left:$this.offset().left,width:width})}else{$this.removeClass("pinned")}})}_count()});function _hideHeader(){var prevScroll=0,hidden=false,down=true,$header=$("header"),hH=$header.outerHeight();if(!$header.hasClass("pinned")){$(window).on("scroll resize",function(){var curScroll=$(this).scrollTop();down=prevScroll<curScroll;if(down){if(!hidden&&curScroll>hH){$header.stop().animate({top:-hH},100);hidden=true}}else{if(hidden&&prevScroll>curScroll){$header.stop().animate({top:0},100);hidden=false}}prevScroll=curScroll})}}_hideHeader()});